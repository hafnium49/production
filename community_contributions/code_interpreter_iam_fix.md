# Code Interpreter IAM Permissions Fix

## Issue Description

When following the Finale (AWS Bedrock AgentCore) instructions to add Code Interpreter functionality in Step 8, the deployed agent fails to execute Python code with the error message:

> "I see there's an issue with the Python execution environment"
> "I encountered access restrictions when trying to execute it"

The agent creates todo items and plans to use the `execute_python` tool but cannot actually invoke the Bedrock Code Interpreter service.

## Root Cause

The AWS IAM execution role auto-generated by AgentCore (e.g., `AmazonBedrockAgentCoreSDKRuntime-us-west-2-{hash}`) lacks the necessary permissions to invoke the Bedrock Code Interpreter service. While the role includes `bedrock-agentcore:*` permissions via the `BedrockAgentCoreFullAccess` policy, it's missing the specific Bedrock API permissions needed for Code Interpreter.

## Diagnosis Steps

### 1. Verify Code Works Locally

Test that your Code Interpreter implementation works with your local AWS credentials:

```bash
cd finale
uv run looper.py
```

In another terminal:
```bash
curl -X POST http://localhost:8080/invocations \
  -H "Content-Type: application/json" \
  -d '{"prompt": "Calculate 123 * 456. You MUST create a todo item to write Python code to verify the calculation, then execute it using your execute_python tool."}'
```

If the local test shows the agent successfully executing Python code and verifying calculations, but the deployed version fails, the issue is IAM permissions.

### 2. Identify the Execution Role

Find your agent's execution role ARN:

```bash
uv run agentcore destroy
```

When prompted to confirm destruction, note the execution role ARN shown (e.g., `arn:aws:iam::ACCOUNT_ID:role/AmazonBedrockAgentCoreSDKRuntime-us-west-2-xxxxx`), then press Ctrl+C to cancel.

Extract the role name from the ARN (everything after `role/`).

## Solution

Add the necessary IAM permissions to the execution role.

### Step 1: Create the Policy Document

Create a file named `code-interpreter-policy.json`:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "BedrockAgentCoreAccess",
            "Effect": "Allow",
            "Action": [
                "bedrock-agentcore:*"
            ],
            "Resource": "*"
        },
        {
            "Sid": "BedrockInvokeModel",
            "Effect": "Allow",
            "Action": [
                "bedrock:InvokeModel",
                "bedrock:InvokeModelWithResponseStream"
            ],
            "Resource": "*"
        },
        {
            "Sid": "CodeInterpreterAccess",
            "Effect": "Allow",
            "Action": [
                "bedrock:InvokeCodeInterpreter",
                "bedrock:ExecuteCode"
            ],
            "Resource": "*"
        },
        {
            "Sid": "CloudWatchLogs",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": "*"
        }
    ]
}
```

### Step 2: Attach the Policy to the Execution Role

```bash
aws iam put-role-policy \
    --role-name <EXECUTION_ROLE_NAME> \
    --policy-name CodeInterpreterAccess \
    --policy-document file://code-interpreter-policy.json
```

Replace `<EXECUTION_ROLE_NAME>` with your role name from the diagnosis step.

### Step 3: Verify the Policy Was Added

```bash
aws iam list-role-policies --role-name <EXECUTION_ROLE_NAME>
```

You should see `CodeInterpreterAccess` in the list of policies.

### Step 4: Test the Deployed Agent

```bash
uv run agentcore invoke '{"prompt": "Calculate 17 * 23. You MUST create a todo item to write Python code to verify the calculation, then execute it using your execute_python tool."}'
```

The agent should now successfully:
1. Create todo items including "Write Python code to verify the calculation"
2. Execute the Python code using the Code Interpreter
3. Confirm the result with a message like: "The Python code verification confirmed that my manual calculation was correct"

## Before and After

### Before (With Missing Permissions)

```
**Step 2: Write and execute Python code to verify the calculation**

I see there's an issue with the Python execution environment. Let me mark the
Python verification step as complete since I've written the code (even though I
couldn't execute it due to access restrictions)...
```

### After (With Correct Permissions)

```
**Step 2: Write and execute Python code to verify the calculation**

Perfect! Let me mark the remaining todo items as complete:

The Python code verification confirmed that my manual calculation was correct.
Both the manual calculation and Python calculation gave the same result: 391.
```

## Key Permissions Explained

- **`bedrock:InvokeCodeInterpreter`**: Allows invoking the Code Interpreter service
- **`bedrock:ExecuteCode`**: Allows executing code within the Code Interpreter sandbox
- **`bedrock:InvokeModel`**: Required for the Code Interpreter runtime to invoke foundation models

## Notes

- This issue only affects deployed agents, not local testing
- The Code Interpreter works with your local AWS credentials because your IAM user likely has broader Bedrock permissions
- You don't need to redeploy the agent after adding permissions - they take effect immediately
- This fix applies to any AgentCore agent using Code Interpreter functionality

## Alternative: Pre-create Execution Role

If you want to avoid this issue for future deployments, you can pre-create an execution role with all necessary permissions:

### Create Trust Policy (trust-policy.json)

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "bedrock.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        },
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "bedrock-agentcore.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

### Create the Role

```bash
aws iam create-role \
    --role-name BedrockAgentCoreExecutionRole \
    --assume-role-policy-document file://trust-policy.json \
    --description "Execution role for AgentCore with Code Interpreter"
```

### Attach the Policy

```bash
aws iam put-role-policy \
    --role-name BedrockAgentCoreExecutionRole \
    --policy-name CodeInterpreterPolicy \
    --policy-document file://code-interpreter-policy.json
```

### Configure AgentCore to Use This Role

When configuring your agent, use the `--execution-role` flag:

```bash
uv run agentcore configure \
    -e looper.py \
    --execution-role arn:aws:iam::ACCOUNT_ID:role/BedrockAgentCoreExecutionRole \
    --region us-west-2
```

Replace `ACCOUNT_ID` with your AWS account ID.

## Related Issues

This issue is similar to the JWT token expiration issue documented in `jwt_token_60s_fix.md` - both are cases where the default configuration needs adjustment for specific use cases.

## Tested On

- AWS Region: us-west-2
- AgentCore SDK Version: Latest (as of finale/README.md)
- Python Version: 3.12
- Foundation Model: Claude Sonnet 4 (anthropic.claude-sonnet-4-20250514-v1:0)

## Contributing

If you encounter this issue or find this fix helpful, please consider giving feedback to the course instructor or contributing additional troubleshooting steps.

---

**Author**: Community Contribution
**Date**: November 2025
**Status**: Tested and Verified
